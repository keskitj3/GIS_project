<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-cabaple" content="yes">
    <title>Liikuntapaikat kartalla</title>
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.10.1/css/ol.css" type="text/css">
    <script src="http://openlayers.org/en/v3.10.1/build/ol.js"></script>
    <style>
	    #header {
	background-color:#006600;
	color:black;
	text-align:center;
	width:70%;
	      	}
	    #nav {
	line-height:30px;
	background-color:#00CC00;
	width:10%;
	float:left;
		}
	    #footer {
	background-color:#006600;
	color:black;
	clear:both;
	text-align:left;
	width:70%;
	    	}
    </style>
    
    <!-- Tassa scriptissa luodaan kaikki kartassa esiintyvat funktiot ja tyokalut -->
    <script>
      var map
      ol.ProxyHost = "/cgi-bin/proxy.cgi?url=";

      function init() {
      	// Luo kartan, jossa on navigointi mahdollisuus
      	
	

	/*malli
	var wmsSource = new ol.source.TileWMS({
  url: 'http://demo.boundlessgeo.com/geoserver/wms',
  params: {'LAYERS': 'ne:ne'},
  serverType: 'geoserver',
  crossOrigin: ''
});
*/
	// Luodaan WMS taso, kutsumalla se geoserverilta. Samalla asetetaan sille halutut parametrit
	var LiikuntaSource = new ol.ImageWMS({
		url: 'http://130.233.249.20:8080/geoserver/WMS/wms'
		params: {'LAYERS': 'WMS:liikuntapaikat'},
		serverType: 'geoserver',
		crossOrigin: 'anonymous'
	})
	
	/*	"Liikuntapaikat WMS", "http://130.233.249.20:8080/geoserver/WMS/wms",
		{layers: "WMS:liikuntapaikat",
		transparent: true,
		format: 'image/png'},
		{'opacity': 0.66, 'isBaseLayer': false, projection: 'EPSG:900913'});
	*/	
	var liikuntalayer = new ol.layer.Image({
  		source: LiikuntaSource
		});
	
	/*var vaesto = new ol.layer.Vector("Vaesto", "http://130.233.249.20:8080/geoserver/WMS/wms",
		{layers: "WMS:vaki2014_1km",
		transparent: true,
		format: 'image/png'},
		{'opacity': 0.66, 'isBaseLayer': false, projection: 'EPSG:900913'});
		
	var vaesto_kp = new ol.layer.Vector("Vaesto_kp", "http://130.233.249.20:8080/geoserver/WMS/wms",
		{layers: "WMS:vaki2014_1km_kp",
		transparent: true,
		format: 'image/png'},
		{'opacity': 0.66, 'isBaseLayer': false, projection: 'EPSG:900913'});
 
	 Lisaa WFS tason
	var liikuntapaikat_wfs = new OpenLayers.Layer.Vector("Liikuntapaikat WFS", {
		strategies: [new OpenLayers.Strategy.BBOX()],
		protocol: new OpenLayers.Protocol.WFS({
			version: "1.1.0",
			url: "http://130.233.249.20:8080/geoserver/wfs",
			featurePrefix : "WMS",
			featureType: "WFS_pisteet",
			featureNS: "http://130.233.249.20",
			geometryName: "the_geom",
			srsName: "EPSG:4326"})
		});

	var vaesto_wfs = new OpenLayers.Layer.Vector("Vaesto WFS", {
		strategies: [new OpenLayers.Strategy.Fixed()],
		protocol: new OpenLayers.Protocol.WFS({
			version: "1.1.0",
			url: "http://130.233.249.20:8080/geoserver/wfs",
			featurePrefix: "WMS",
			featureType: "wfs_vaki2014_1km_kp",
			featureNS: "http://130.233.249.20",
			geometryName: "the_geom",
			srsName: "EPSG:4326"})
		});
	*/
	// Lisataan aikasemmin luodut tasot kartalle
	//ol.Map.addLayers([liikuntapaikat, vaesto, vaesto_kp]);

	//ol.layer.Base(liikuntapaikat)

	// Asetetaan perusnakyman parametrit eli sijainti ja zoomaus taso
	/*var lat = 60.170833;
	var lon = 24.9375;
	var zoom = 14;
	*/
	// Lisaa merkintakuviot yhdeksi tasoksi
	//var markers = new OpenLayers.Layer.Markers("Markers");
	//map.addLayer(markers);
	
	// Etsii kayttajan sijainnin ja tallentaa sen Location nimiseen elementtiin, jota voidaan kutsua universaalisti
/*	navigator.geolocation.getCurrentPosition(function(position) {
		document.getElementById('Location').innerHTML= 
		" Latitude: " + position.coords.latitude + 
		" Longitude: " + position.coords.longitude;
		*/
		// Tallentaa koordinaatit lonlat muuttujaan
		//var lonLat = new OpenLayers.LonLat(position.coords.longitude, position.coords.latitude)
		//.transform(new OpenLayers.Projection("EPSG:4326"), // Muuttaa koordinaatiston WGS 1984:sta EPSG 4326:n
		
		//map.getProjectionObject()); // to Spherical Mercator Projection
		//markers.addMarker(new OpenLayers.Marker(lonLat)); // Lisaa markkerin haetulle sijainnille
		//map.setCenter(lonLat, zoom); // Asettaa kartan kyseiselle sijainnille
	//});
	
	//tehdaan kartta
	map = new ol.Map({
  		controls: ol.control.defaults({
    		attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
      		collapsible: false
    			})
  		}).extend([
    		new ol.control.ZoomToExtent({
      		extent: [
        		813079.7791264898, 5929220.284081122,
        		848966.9639063801, 5936863.986909639
      			]
			 })
  		]),
  		layers: [
    			/*new ol.layer.Tile({
      			source: new ol.source.OSM()
    },*/ LiikuntaLayer//, vaesto, vaesto_kp
  ],
  target: 'map',
  view: new ol.View({
    center: [0, 0],
    zoom: 2
  })
});

//Paikannus
var geolocation = new ol.Geolocation({
  projection: view.getProjection()
});

function el(id) {
  return document.getElementById(id);
}

el('track').addEventListener('change', function() {
  geolocation.setTracking(this.checked);
});

// update the HTML page when the position changes.
geolocation.on('change', function() {
  el('accuracy').innerText = geolocation.getAccuracy() + ' [m]';
  el('altitude').innerText = geolocation.getAltitude() + ' [m]';
  el('altitudeAccuracy').innerText = geolocation.getAltitudeAccuracy() + ' [m]';
  el('heading').innerText = geolocation.getHeading() + ' [rad]';
  el('speed').innerText = geolocation.getSpeed() + ' [m/s]';
});

// handle geolocation error.
geolocation.on('error', function(error) {
  var info = document.getElementById('info');
  info.innerHTML = error.message;
  info.style.display = '';
});

var accuracyFeature = new ol.Feature();
geolocation.on('change:accuracyGeometry', function() {
  accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
});

var positionFeature = new ol.Feature();
positionFeature.setStyle(new ol.style.Style({
  image: new ol.style.Circle({
    radius: 6,
    fill: new ol.style.Fill({
      color: '#3399CC'
    }),
    stroke: new ol.style.Stroke({
      color: '#fff',
      width: 2
    })
  })
}));

geolocation.on('change:position', function() {
  var coordinates = geolocation.getPosition();
  positionFeature.setGeometry(coordinates ?
      new ol.geom.Point(coordinates) : null);
});

var featuresOverlay = new ol.layer.Vector({
  map: map,
  source: new ol.source.Vector({
    features: [accuracyFeature, positionFeature]
  })
});
	
	
	
	/*/ Lisataan kartalle muutamat tarkeat controllit
	map.addControl(new OpenLayers.Control.PanZoomBar());
	map.addControl(new OpenLayers.Control.LayerSwitcher());
	map.addControl(new OpenLayers.Control.ScaleLine());
	map.addControl(new OpenLayers.Control.Mouseposition());
	*/		
      }
    </script>
  </head>
	
  <body onload="init()">
  	
    <!-- Header osio, johon tulee otsikko ja ehka joki valikko -->
    <div id="header">
    	<h1>Liikuntapaikat kartalla</h1>
    </div>
    
    <!-- Sivupalkki -->
    <!--
    <div id="nav">
    	<button type="button" onclick="alert('Doesn't work yet');">Find route</button>
    	<button type="button" onclick="alert('Doesn't work yet');">Analyze</button>
    </div>
    -->
    
    <!-- Lisaa kartan halutulla koolla -->
    <div id="map" style="height:500px; width:70%"></div>
    
    <!-- Sijoittaa sijannin funktiosta sivulle haluttuun paikkaan -->
    <p id="Location"></p>
    
    <!-- Tahan voidaan laittaa sivun alaosan tietoja, kuten tekijat ja copyright merkinnat -->
    <div id="footer">
    	<h>GIS Software Development course</h>
    </div>
    <label class="checkbox" for="track">
      <input id="track" type="checkbox"/>track position
    </label>

  </body>
</html>
